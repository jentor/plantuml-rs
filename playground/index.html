<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>PlantUML-RS Playground</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: #1a1a2e;
            color: #eee;
            min-height: 100vh;
        }

        .header {
            background: #16213e;
            padding: 1rem 2rem;
            border-bottom: 1px solid #0f3460;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .header h1 {
            font-size: 1.5rem;
            color: #e94560;
        }

        .header .version {
            color: #888;
            font-size: 0.9rem;
        }

        .header .links {
            display: flex;
            gap: 1rem;
        }

        .header a {
            color: #4db5ff;
            text-decoration: none;
        }

        .header a:hover {
            text-decoration: underline;
        }

        .container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            height: calc(100vh - 60px);
        }

        .panel {
            display: flex;
            flex-direction: column;
            border-right: 1px solid #0f3460;
        }

        .panel-header {
            background: #16213e;
            padding: 0.75rem 1rem;
            border-bottom: 1px solid #0f3460;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .panel-title {
            font-weight: 600;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: #aaa;
        }

        .panel-content {
            flex: 1;
            overflow: auto;
        }

        textarea {
            width: 100%;
            height: 100%;
            background: #0f0f1a;
            color: #f0f0f0;
            border: none;
            padding: 1rem;
            font-family: 'JetBrains Mono', 'Fira Code', 'Consolas', monospace;
            font-size: 14px;
            line-height: 1.5;
            resize: none;
            outline: none;
        }

        textarea::placeholder {
            color: #555;
        }

        .output {
            background: #fff;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 1rem;
            min-height: 100%;
        }

        .output svg {
            max-width: 100%;
            max-height: 100%;
        }

        .error {
            background: #2d1f1f;
            color: #ff6b6b;
            padding: 1rem;
            font-family: monospace;
            white-space: pre-wrap;
            word-break: break-word;
        }

        .controls {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }

        button {
            background: #e94560;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.85rem;
            font-weight: 500;
            transition: background 0.2s;
        }

        button:hover {
            background: #ff6b81;
        }

        button:disabled {
            background: #555;
            cursor: not-allowed;
        }

        button.secondary {
            background: #0f3460;
        }

        button.secondary:hover {
            background: #1a4a7a;
        }

        select {
            background: #0f3460;
            color: white;
            border: none;
            padding: 0.5rem;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.85rem;
        }

        .status {
            font-size: 0.8rem;
            color: #888;
        }

        .status.success {
            color: #4ecdc4;
        }

        .status.error {
            color: #ff6b6b;
        }

        .loading {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: #888;
        }

        .loading::before {
            content: '';
            width: 16px;
            height: 16px;
            border: 2px solid #333;
            border-top-color: #e94560;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .examples-dropdown {
            position: relative;
        }

        .examples-menu {
            display: none;
            position: absolute;
            top: 100%;
            left: 0;
            background: #16213e;
            border: 1px solid #0f3460;
            border-radius: 4px;
            min-width: 200px;
            z-index: 100;
            max-height: 400px;
            overflow-y: auto;
        }

        .examples-dropdown:hover .examples-menu {
            display: block;
        }

        .examples-menu button {
            display: block;
            width: 100%;
            text-align: left;
            background: transparent;
            border-radius: 0;
            padding: 0.75rem 1rem;
            border-bottom: 1px solid #0f3460;
        }

        .examples-menu button:last-child {
            border-bottom: none;
        }

        .examples-menu button:hover {
            background: #0f3460;
        }

        .toolbar {
            background: #16213e;
            padding: 0.5rem 1rem;
            border-bottom: 1px solid #0f3460;
            display: flex;
            gap: 1rem;
            align-items: center;
            flex-wrap: wrap;
        }

        .toolbar-group {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }

        .toolbar-label {
            font-size: 0.8rem;
            color: #888;
        }

        .info-panel {
            background: #0f0f1a;
            padding: 1rem;
            font-family: monospace;
            font-size: 0.85rem;
            line-height: 1.6;
            max-height: 200px;
            overflow-y: auto;
        }

        .info-panel pre {
            white-space: pre-wrap;
            word-break: break-word;
        }

        .tabs {
            display: flex;
            border-bottom: 1px solid #0f3460;
        }

        .tab {
            padding: 0.5rem 1rem;
            background: transparent;
            border: none;
            color: #888;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.2s;
        }

        .tab:hover {
            color: #fff;
        }

        .tab.active {
            color: #e94560;
            border-bottom-color: #e94560;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        @media (max-width: 900px) {
            .container {
                grid-template-columns: 1fr;
                grid-template-rows: 1fr 1fr;
            }

            .panel {
                border-right: none;
                border-bottom: 1px solid #0f3460;
            }
        }
    </style>
</head>
<body>
    <header class="header">
        <div>
            <h1>PlantUML-RS Playground</h1>
            <span class="version" id="version">Загрузка...</span>
        </div>
        <div class="links">
            <a href="https://plantuml.com/sitemap-language-specification" target="_blank">PlantUML Docs</a>
            <a href="https://github.com/user/plantuml-rs" target="_blank">GitHub</a>
        </div>
    </header>

    <div class="toolbar">
        <div class="toolbar-group">
            <span class="toolbar-label">Тема:</span>
            <select id="theme-select">
                <option value="default">Default</option>
                <option value="dark">Dark</option>
                <option value="minimal">Minimal</option>
                <option value="sketchy">Sketchy</option>
                <option value="cerulean">Cerulean</option>
            </select>
        </div>

        <div class="toolbar-group examples-dropdown">
            <button class="secondary">Примеры ▾</button>
            <div class="examples-menu" id="examples-menu">
                <!-- Примеры загружаются динамически -->
            </div>
        </div>

        <div class="toolbar-group">
            <button id="render-btn">Рендер (Ctrl+Enter)</button>
            <button id="download-btn" class="secondary">Скачать SVG</button>
        </div>

        <div class="toolbar-group">
            <span class="status" id="status"></span>
        </div>
    </div>

    <div class="container">
        <div class="panel">
            <div class="panel-header">
                <span class="panel-title">Исходный код</span>
                <button class="secondary" id="clear-btn" style="padding: 0.25rem 0.5rem; font-size: 0.75rem;">Очистить</button>
            </div>
            <div class="panel-content">
                <textarea id="source" placeholder="Введите PlantUML код здесь...

@startuml
Alice -> Bob: Hello
Bob --> Alice: Hi!
@enduml"></textarea>
            </div>
        </div>

        <div class="panel" style="border-right: none;">
            <div class="panel-header">
                <div class="tabs">
                    <button class="tab active" data-tab="render">Результат</button>
                    <button class="tab" data-tab="ast">AST (JSON)</button>
                </div>
            </div>
            <div class="panel-content">
                <div class="tab-content active" id="tab-render">
                    <div class="output" id="output">
                        <span style="color: #888;">Нажмите "Рендер" или Ctrl+Enter</span>
                    </div>
                </div>
                <div class="tab-content" id="tab-ast">
                    <div class="info-panel" id="ast-output">
                        <pre>AST появится после рендеринга</pre>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import init, { render, render_with_theme, parse_to_json, version, available_themes } from './pkg/plantuml_wasm.js';

        // Примеры диаграмм
        const examples = {
            'Sequence: Простой': `@startuml
Alice -> Bob: Привет!
Bob --> Alice: Привет!
Alice -> Bob: Как дела?
Bob --> Alice: Отлично!
@enduml`,

            'Sequence: С участниками': `@startuml
participant "Пользователь" as User
participant "Сервер" as Server
database "База данных" as DB

User -> Server: GET /api/users
Server -> DB: SELECT * FROM users
DB --> Server: users[]
Server --> User: 200 OK
@enduml`,

            'Sequence: Фрагменты': `@startuml
Alice -> Bob: Запрос авторизации

alt успешная авторизация
    Bob --> Alice: Токен доступа
else неверный пароль
    Bob --> Alice: Ошибка 401
else аккаунт заблокирован
    Bob --> Alice: Ошибка 403
end

opt Запомнить меня
    Alice -> Bob: Сохранить сессию
end

loop каждые 5 минут
    Alice -> Bob: Ping
    Bob --> Alice: Pong
end
@enduml`,

            'Sequence: Группировка': `@startuml
box "Фронтенд" #LightBlue
    participant "React App" as React
    participant "Redux Store" as Redux
end box

box "Бэкенд" #LightGreen
    participant "API Gateway" as API
    participant "Auth Service" as Auth
    participant "User Service" as User
end box

React -> Redux: dispatch(login)
Redux -> API: POST /auth/login
API -> Auth: validateCredentials
Auth -> User: getUserById
User --> Auth: user data
Auth --> API: JWT token
API --> Redux: { token, user }
Redux --> React: state updated
@enduml`,

            'Class: Простой': `@startuml
class User {
    +id: int
    +name: string
    +email: string
    --
    +login(): bool
    +logout(): void
}

class Order {
    +id: int
    +date: datetime
    +total: decimal
    --
    +calculate(): decimal
}

User "1" -- "*" Order : places
@enduml`,

            'Class: Наследование': `@startuml
abstract class Animal {
    +name: string
    {abstract} +speak(): void
}

class Dog extends Animal {
    +breed: string
    +speak(): void
}

class Cat extends Animal {
    +color: string
    +speak(): void
}

interface Flyable {
    +fly(): void
}

class Bird extends Animal implements Flyable {
    +wingspan: int
    +speak(): void
    +fly(): void
}
@enduml`,

            'Class: Композиция': `@startuml
class Car {
    +brand: string
    +model: string
}

class Engine {
    +power: int
    +type: string
}

class Wheel {
    +size: int
    +brand: string
}

Car *-- Engine : has
Car *-- "4" Wheel : has
@enduml`,

            'State: Простой': `@startuml
[*] --> Idle

Idle --> Processing : start
Processing --> Completed : success
Processing --> Failed : error
Completed --> [*]
Failed --> Idle : retry
Failed --> [*] : abort
@enduml`,

            'State: Вложенные': `@startuml
[*] --> Active

state Active {
    [*] --> Idle
    Idle --> Running : start
    Running --> Paused : pause
    Paused --> Running : resume
    Running --> Idle : stop
}

Active --> Inactive : disable
Inactive --> Active : enable
Inactive --> [*] : delete
@enduml`,

            'Component: Простой': `@startuml
package "Frontend" {
    [React App]
    [Redux Store]
}

package "Backend" {
    [API Gateway]
    [Auth Service]
    [User Service]
}

database "PostgreSQL" {
    [Users DB]
}

[React App] --> [Redux Store]
[Redux Store] --> [API Gateway]
[API Gateway] --> [Auth Service]
[API Gateway] --> [User Service]
[User Service] --> [Users DB]
@enduml`,

            'UseCase: Простой': `@startuml
left to right direction

actor "Покупатель" as Customer
actor "Менеджер" as Manager

rectangle "Интернет-магазин" {
    usecase "Просмотр каталога" as UC1
    usecase "Добавить в корзину" as UC2
    usecase "Оформить заказ" as UC3
    usecase "Управление товарами" as UC4
    usecase "Обработка заказов" as UC5
}

Customer --> UC1
Customer --> UC2
Customer --> UC3
Manager --> UC4
Manager --> UC5
@enduml`,

            'Activity: Простой': `@startuml
start
:Получить заказ;

if (В наличии?) then (да)
    :Упаковать товар;
    :Отправить курьером;
else (нет)
    :Заказать у поставщика;
    :Ждать поставку;
    :Упаковать товар;
    :Отправить курьером;
endif

:Уведомить клиента;
stop
@enduml`,

            'Object: Диаграмма': `@startuml
object "john : User" as john {
    id = 1
    name = "John Doe"
    email = "john@example.com"
}

object "order1 : Order" as order1 {
    id = 101
    date = "2024-01-15"
    total = 150.00
}

object "order2 : Order" as order2 {
    id = 102
    date = "2024-01-20"
    total = 75.50
}

john --> order1 : places
john --> order2 : places
@enduml`,

            'ER: Диаграмма': `@startuml
entity User {
    * id : int <<PK>>
    --
    * name : varchar(100)
    * email : varchar(255)
    created_at : datetime
}

entity Order {
    * id : int <<PK>>
    --
    * user_id : int <<FK>>
    * total : decimal
    * status : enum
    created_at : datetime
}

entity OrderItem {
    * id : int <<PK>>
    --
    * order_id : int <<FK>>
    * product_id : int <<FK>>
    * quantity : int
    * price : decimal
}

entity Product {
    * id : int <<PK>>
    --
    * name : varchar(255)
    * price : decimal
    * stock : int
}

User ||--o{ Order : places
Order ||--|{ OrderItem : contains
Product ||--o{ OrderItem : includes
@enduml`,

            'Gantt: Диаграмма': `@startuml
@startgantt
Project starts 2024-01-01

[Анализ требований] lasts 5 days
[Дизайн] lasts 7 days
[Дизайн] starts at [Анализ требований]'s end

[Разработка] lasts 15 days
[Разработка] starts at [Дизайн]'s end

[Тестирование] lasts 7 days
[Тестирование] starts at [Разработка]'s end

[Деплой] lasts 2 days
[Деплой] starts at [Тестирование]'s end

@endgantt
@enduml`,

            'MindMap: Диаграмма': `@startmindmap
* Веб-разработка
** Frontend
*** HTML/CSS
*** JavaScript
**** React
**** Vue
**** Angular
*** TypeScript
** Backend
*** Node.js
*** Python
**** Django
**** FastAPI
*** Go
*** Rust
** DevOps
*** Docker
*** Kubernetes
*** CI/CD
@endmindmap`,

            'WBS: Диаграмма': `@startwbs
* Проект
** Подготовка
*** Анализ требований
*** Техническое задание
** Разработка
*** Backend
**** API
**** База данных
*** Frontend
**** UI компоненты
**** Интеграция
** Тестирование
*** Unit тесты
*** Интеграционные тесты
** Деплой
@endwbs`,

            'JSON: Диаграмма': `@startjson
{
    "user": {
        "id": 1,
        "name": "John Doe",
        "email": "john@example.com",
        "roles": ["admin", "user"],
        "settings": {
            "theme": "dark",
            "notifications": true
        }
    },
    "orders": [
        {"id": 101, "total": 150.00},
        {"id": 102, "total": 75.50}
    ]
}
@endjson`,

            'YAML: Диаграмма': `@startyaml
server:
  host: localhost
  port: 8080
  
database:
  driver: postgresql
  host: db.example.com
  port: 5432
  name: myapp
  
logging:
  level: info
  format: json
  outputs:
    - stdout
    - file
@endyaml`,

            'Timing: Диаграмма': `@startuml
robust "Сервер" as Server
concise "Клиент" as Client

@0
Server is Idle
Client is Disconnected

@100
Client is Connecting
Server is Processing

@200
Client is Connected
Server is Active

@500
Client is Requesting
Server is Busy

@600
Client is Receiving
Server is Sending

@800
Client is Connected
Server is Active

@1000
Client is Disconnecting
Server is Closing

@1100
Client is Disconnected
Server is Idle
@enduml`,

            'Network: Диаграмма': `@startuml
nwdiag {
    network dmz {
        address = "210.x.x.x/24"
        web01 [address = "210.x.x.1"];
        web02 [address = "210.x.x.2"];
    }
    
    network internal {
        address = "172.x.x.x/24"
        web01 [address = "172.x.x.1"];
        web02 [address = "172.x.x.2"];
        db01;
    }
    
    network db {
        address = "192.168.x.x/24"
        db01 [address = "192.168.x.1"];
        db02 [address = "192.168.x.2"];
    }
}
@enduml`,

            'Salt: Wireframe': `@startsalt
{
    Логин
    ==
    "Имя пользователя:" | "user@example.com"
    "Пароль:"           | "****"
    []Запомнить меня
    [  Войти  ] | [Отмена]
}
@endsalt`
        };

        let wasm;
        let currentSvg = '';

        async function initialize() {
            try {
                await init();
                
                const ver = version();
                document.getElementById('version').textContent = `v${ver}`;
                
                // Загружаем доступные темы
                const themes = available_themes();
                console.log('Доступные темы:', themes);
                
                // Заполняем меню примеров
                const examplesMenu = document.getElementById('examples-menu');
                for (const [name, code] of Object.entries(examples)) {
                    const btn = document.createElement('button');
                    btn.textContent = name;
                    btn.onclick = () => {
                        document.getElementById('source').value = code;
                        doRender();
                    };
                    examplesMenu.appendChild(btn);
                }
                
                setStatus('Готово', 'success');
                
                // Загружаем первый пример
                document.getElementById('source').value = examples['Sequence: Простой'];
                doRender();
                
            } catch (e) {
                setStatus('Ошибка инициализации: ' + e.message, 'error');
                console.error(e);
            }
        }

        function setStatus(message, type = '') {
            const status = document.getElementById('status');
            status.textContent = message;
            status.className = 'status ' + type;
        }

        function doRender() {
            const source = document.getElementById('source').value;
            const theme = document.getElementById('theme-select').value;
            const output = document.getElementById('output');
            const astOutput = document.getElementById('ast-output');
            
            if (!source.trim()) {
                output.innerHTML = '<span style="color: #888;">Введите PlantUML код</span>';
                astOutput.innerHTML = '<pre>Нет данных</pre>';
                return;
            }
            
            const startTime = performance.now();
            
            try {
                // Рендерим SVG
                let svg;
                if (theme === 'default') {
                    svg = render(source);
                } else {
                    svg = render_with_theme(source, theme);
                }
                
                currentSvg = svg;
                output.innerHTML = svg;
                output.classList.remove('error');
                
                const elapsed = (performance.now() - startTime).toFixed(1);
                setStatus(`Рендеринг: ${elapsed}ms`, 'success');
                
                // Парсим AST
                try {
                    const ast = parse_to_json(source);
                    const formatted = JSON.stringify(JSON.parse(ast), null, 2);
                    astOutput.innerHTML = `<pre>${escapeHtml(formatted)}</pre>`;
                } catch (e) {
                    astOutput.innerHTML = `<pre style="color: #ff6b6b;">Ошибка парсинга AST: ${escapeHtml(e.toString())}</pre>`;
                }
                
            } catch (e) {
                output.innerHTML = '';
                output.classList.add('error');
                output.innerHTML = `<div class="error">${escapeHtml(e.toString())}</div>`;
                astOutput.innerHTML = `<pre style="color: #ff6b6b;">Ошибка: ${escapeHtml(e.toString())}</pre>`;
                setStatus('Ошибка рендеринга', 'error');
                currentSvg = '';
            }
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function downloadSvg() {
            if (!currentSvg) {
                alert('Сначала выполните рендеринг диаграммы');
                return;
            }
            
            const blob = new Blob([currentSvg], { type: 'image/svg+xml' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'diagram.svg';
            a.click();
            URL.revokeObjectURL(url);
        }

        // Event listeners
        document.getElementById('render-btn').addEventListener('click', doRender);
        document.getElementById('download-btn').addEventListener('click', downloadSvg);
        document.getElementById('clear-btn').addEventListener('click', () => {
            document.getElementById('source').value = '';
            document.getElementById('output').innerHTML = '<span style="color: #888;">Введите PlantUML код</span>';
            document.getElementById('ast-output').innerHTML = '<pre>Нет данных</pre>';
            currentSvg = '';
        });

        document.getElementById('theme-select').addEventListener('change', doRender);

        document.getElementById('source').addEventListener('keydown', (e) => {
            if (e.ctrlKey && e.key === 'Enter') {
                e.preventDefault();
                doRender();
            }
        });

        // Tabs
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                
                tab.classList.add('active');
                document.getElementById('tab-' + tab.dataset.tab).classList.add('active');
            });
        });

        // Auto-render on input with debounce
        let renderTimeout;
        document.getElementById('source').addEventListener('input', () => {
            clearTimeout(renderTimeout);
            renderTimeout = setTimeout(doRender, 500);
        });

        // Initialize
        initialize();
    </script>
</body>
</html>
